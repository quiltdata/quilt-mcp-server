# Development workflow targets
# Migrated from app/Makefile for Phase 1 consolidation

# Load environment variables from .env if it exists
sinclude .env
export

# Development endpoint configuration
DEV_ENDPOINT ?= http://127.0.0.1:8001/mcp/

.PHONY: test test-unit test-integration test-ci lint coverage coverage-unit coverage-integration coverage-tools run run-inspector kill dev-clean

# Test Targets
test:
	@echo "Running local tests..."
	@uv sync --group test
	@if [ -d "tests" ] && [ "$$(find tests -name "*.py" | wc -l)" -gt 0 ]; then \
		export PYTHONPATH="src" && uv run python -m pytest tests/ -v; \
	else \
		echo "No tests found, running import test..."; \
		export PYTHONPATH="src" && uv run python -c "from quilt_mcp.server import main; from quilt_mcp.tools import auth, buckets, packages, package_ops; print('✅ All imports successful')"; \
	fi
	@echo "Running DXT package validation..."
	@$(MAKE) -f make.deploy dxt-validate

test-unit:
	@echo "Running unit tests only (no AWS/integration tests)..."
	@uv sync --group test
	@export PYTHONPATH="src" && uv run python -m pytest tests/ -v -m "not aws and not search"

test-integration:
	@echo "Running integration tests (with AWS)..."
	@uv sync --group test
	@export PYTHONPATH="src" && uv run python -m pytest tests/ -v

test-ci:
	@echo "Running CI tests (skipping search/slow tests)..."
	@uv sync --group test
	@mkdir -p build/test-results
	@export PYTHONPATH="src" && QUILT_DISABLE_QUILT3_SESSION=1 uv run python -m pytest tests/ -v -m "not search and not slow" --timeout=$${PYTEST_TIMEOUT:-120} --disable-warnings \
		--junitxml=build/test-results/results.xml --cov=quilt_mcp --cov-report=xml:src/coverage.xml

# Code Quality Targets
lint:
	@echo "Running code linting and auto-fixing..."
	@uv sync --group lint
	@echo "Running ruff (format + lint + type check) - auto-fixing..."
	@uv run ruff format src/quilt_mcp/ tests/
	@uv run ruff check --fix src/quilt_mcp/ tests/
	@echo "✅ All linting completed"

coverage: coverage-unit coverage-integration
	@echo "Split coverage analysis complete."
	@echo "Run 'make coverage-tools' to generate the split coverage report."

coverage-unit:
	@echo "Running unit tests with coverage..."
	@uv sync --group test
	@mkdir -p build/test-results
	@export PYTHONPATH="src" && uv run python -m pytest tests/ -v -m "not aws and not search" \
		--cov=quilt_mcp --cov-report=xml:build/test-results/coverage-unit.xml

coverage-integration:
	@echo "Running integration tests with coverage..."
	@uv sync --group test
	@mkdir -p build/test-results
	@export PYTHONPATH="src" && uv run python -m pytest tests/ -v -m "aws or search" \
		--cov=quilt_mcp --cov-report=xml:build/test-results/coverage-integration.xml

coverage-tools: coverage-unit coverage-integration
	@echo "Generating split coverage report..."
	@./bin/coverage-tools

# Development Server Targets
run:
	@echo "Starting local MCP server..."
	@uv sync
	@echo "Server starting on $(DEV_ENDPOINT)"
	@export PYTHONPATH="src" && uv run python src/main.py

run-inspector:
	@echo "Launching MCP Inspector for visual testing..."
	@command -v npx >/dev/null || (echo "Error: npx not found. Please install Node.js first." && exit 1)
	@uv sync
	@echo "Starting MCP Inspector with server at $(DEV_ENDPOINT)"
	@echo "Inspector UI will be available at http://127.0.0.1:6274"
	@export PYTHONPATH="src" && npx @modelcontextprotocol/inspector uv run python src/main.py

kill:
	@echo "Killing running MCP server processes..."
	@pkill -f "python.*main.py" 2>/dev/null || echo "No main.py processes found"
	@pkill -f "python.*quilt_mcp" 2>/dev/null || echo "No quilt_mcp processes found" 
	@pkill -f "@modelcontextprotocol/inspector" 2>/dev/null || echo "No MCP Inspector processes found"
	@lsof -ti :8000 | xargs -r kill 2>/dev/null || echo "No processes on port 8000"
	@lsof -ti :8001 | xargs -r kill 2>/dev/null || echo "No processes on port 8001"
	@echo "✅ Server kill completed"

# Cleanup Targets
dev-clean:
	@echo "Cleaning Python cache..."
	@find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "Cleaning test artifacts..."
	@rm -rf build/test-results/ .coverage .coverage.* htmlcov/ .pytest_cache/ 2>/dev/null || true
	@find . -name "*.egg-info" -type d -exec rm -rf {} + 2>/dev/null || true
	@echo "Cleaning build artifacts..."
	@rm -rf build/ dist/ .ruff_cache/ 2>/dev/null || true
	@find . -name ".DS_Store" -delete 2>/dev/null || true
	@echo "✅ Development cleanup completed"