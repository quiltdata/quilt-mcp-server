name: Deploy to ECR

# This workflow builds and pushes the MCP server Docker image to ECR
# on every merge to main. It validates the build and tests HTTPS capability.
# Requires AWS credentials to be configured in GitHub secrets.

on:
  workflow_dispatch:  # Manual-only

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Set up Python
      run: uv python install 3.11
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.CDK_DEFAULT_REGION || 'us-east-1' }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Build and validate Docker image
      run: |
        echo "🔍 Building and validating Docker image..."
        make validate-build
      env:
        UVRUN: uv run
        
    - name: Push to ECR
      run: |
        echo "🚀 Pushing to ECR..."
        # Set ECR registry from login step
        export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}
        export ECR_REPOSITORY=quilt-mcp
        
        # Run catalog-push validation (includes login, push, and pull test)
        make validate-catalog
      env:
        UVRUN: uv run
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: quilt-mcp
        
    - name: Validate deploy capability
      run: |
        echo "🔍 Validating deploy capability (CDK synthesis + HTTPS)..."
        # Only run CDK synthesis tests, not actual deployment
        cd deploy-aws
        uv sync --group deploy > /dev/null
        uv run cdk synth --app "python app.py" --output /tmp/cdk-out-http > /dev/null && echo "✅ HTTP synthesis working"
        ACM_CERT_ARN="arn:aws:acm:us-east-1:123456789012:certificate/test-cert" uv run cdk synth --app "python app.py" --output /tmp/cdk-out-https > /dev/null && echo "✅ HTTPS synthesis working"
        echo "✅ Deploy capability validated"
      env:
        UVRUN: uv run
        CDK_DEFAULT_ACCOUNT: ${{ secrets.CDK_DEFAULT_ACCOUNT }}
        CDK_DEFAULT_REGION: ${{ secrets.CDK_DEFAULT_REGION }}
        
    - name: Output deployment info
      run: |
        echo "✅ Deployment completed successfully!"
        echo "ECR Registry: ${{ steps.login-ecr.outputs.registry }}"
        echo "Repository: quilt-mcp"
        echo "Git SHA: ${{ github.sha }}"
        echo ""
        echo "To deploy to ECS:"
        echo "export ECR_REGISTRY=${{ steps.login-ecr.outputs.registry }}"
        echo "make deploy"