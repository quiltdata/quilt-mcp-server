# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Main Branch Validation

on:
  push:
    branches: [main]
    tags:
      - 'v*'
      - '!v*-dev-*'  # Exclude dev tags - those trigger PR workflow only
  merge_group:
    types: [checks_requested]
  workflow_dispatch:
    inputs:
      simulate_tag:
        description: 'Simulate a tag for testing (e.g., v0.17.2). Leave empty to skip release job.'
        required: false
        type: string

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        python-version: ["3.13", "3.12", "3.11"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        python-version: ${{ matrix.python-version }}

    - name: Run comprehensive tests
      uses: ./.github/actions/run-tests
      with:
        test-target: ${{ startsWith(github.ref, 'refs/tags/') && 'test-ci' || (matrix.python-version == '3.11' && 'coverage' || 'test-ci') }}
        artifact-name: test-results
        python-version: ${{ matrix.python-version }}
      env:
        # AWS credentials for tests that need them
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}

        # Quilt configuration
        QUILT_TEST_BUCKET: ${{ secrets.QUILT_TEST_BUCKET }}
        QUILT_CATALOG_URL: ${{ secrets.QUILT_CATALOG_URL }}
        QUILT_TEST_PACKAGE: ${{ secrets.QUILT_TEST_PACKAGE }}
        QUILT_TEST_ENTRY: ${{ secrets.QUILT_TEST_ENTRY }}
        PLATFORM_TEST_ENABLED: ${{ secrets.PLATFORM_CATALOG_URL != '' && 'true' || 'false' }}
        PLATFORM_CATALOG_URL: ${{ secrets.PLATFORM_CATALOG_URL }}
        PLATFORM_REGISTRY_URL: ${{ secrets.PLATFORM_REGISTRY_URL }}
        PLATFORM_TEST_JWT_SECRET: ${{ secrets.PLATFORM_TEST_JWT_SECRET }}


  # Production release job - runs after tests pass for production tags
  prod-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [test]
    environment: pypi
    permissions:
      contents: write
      id-token: write
    # Only run for production tags (v* but not v*-dev-*) or workflow_dispatch with simulate_tag
    if: |
      contains(needs.test.result, 'success') && (
        (startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-dev-')) ||
        (github.event_name == 'workflow_dispatch' && inputs.simulate_tag != '')
      )

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup build environment
      uses: ./.github/actions/setup-build-env
      with:
        python-version: '3.11'
        include-nodejs: 'true'

    - name: Extract version from tag or input
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          # Use simulated tag from workflow_dispatch input
          TAG_VERSION="${{ inputs.simulate_tag }}"
          TAG_VERSION="${TAG_VERSION#v}"  # Remove 'v' prefix if present
          echo "ðŸ§ª Testing with simulated version: $TAG_VERSION"
        else
          # Extract from actual git tag
          TAG_VERSION=${GITHUB_REF#refs/tags/v}
          echo "ðŸš€ Production Tag Version: $TAG_VERSION"
        fi
        echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT

    - name: Create production release
      uses: ./.github/actions/create-release
      with:
        package-version: ${{ steps.version.outputs.tag_version }}
        build-docker: 'true'
        # pypi-repository-url defaults to '' for PyPI
      env:
        # AWS credentials for Docker ECR push
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION || 'us-east-1' }}
